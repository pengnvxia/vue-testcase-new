<template>
    <div>
        <div v-if="$route.meta.levels !== 3">
        <a-form-model>
            <a-row>
            <a-col :span="12">
            <a-form-model-item label="用例组名称：" :label-col="{ span: 4 }" :wrapper-col="{ span: 10 }">
                <a-input v-model="testcaseGroupForm.groupName"></a-input>
            </a-form-model-item>
            </a-col>
            <a-col :span="12">
            <a-form-model-item label="所属项目：" :label-col="{ span: 4 }" :wrapper-col="{ span: 10 }">
                <a-select v-model="testcaseGroupForm.projectId">
                    <a-select-option :value="item.id" v-for="item in projects">
                        {{ item.projectName }}
                    </a-select-option>
                </a-select>
            </a-form-model-item>
            </a-col>
            </a-row>
            <a-row>
            <a-col :span="12">
            <a-form-model-item label="环境" :label-col="{ span: 4 }" :wrapper-col="{ span: 10 }">
                <a-select v-model="testcaseGroupForm.envId">
                    <a-select-option :value="1">
                        测试
                    </a-select-option>
                    <a-select-option :value="2">
                        生产
                    </a-select-option>
                </a-select>
            </a-form-model-item>
            </a-col>
            </a-row>
                <a-collapse>
                    <a-collapse-panel key="variables" header="Variables">
                        <a-table :columns="variablesColumns" :pagination="false" :data-source="testcaseGroupForm.variables">
                            <template v-for="col in ['name','type','value','database']"
                                      :slot="col"
                                      slot-scope="text,record,index">
                                <a-form-model-item v-if="col=='name'">
                                    <a-input v-model="record.name"/>
                                </a-form-model-item>
                                <a-form-model-item v-if="col=='type'">
                                    <a-select default-value="String" v-model="record.type">
                                        <a-select-option value="String">String</a-select-option>
                                        <a-select-option value="Number">Number</a-select-option>
                                        <a-select-option value="Boolean">Boolean</a-select-option>
                                        <a-select-option value="Sql">Sql</a-select-option>
                                        <a-select-option value="Object">Object</a-select-option>
                                        <a-select-option value="Array">Array</a-select-option>
                                        <a-select-option value="Function">Function</a-select-option>
                                        <a-select-option value="RegExp">RegExp</a-select-option>
                                        <a-select-option value="Null">Null</a-select-option>
                                    </a-select>
                                </a-form-model-item>
                                <a-form-model-item v-if="col=='value'">
                                    <a-input v-model="record.value"/>
                                </a-form-model-item>
                                <a-form-model-item v-if="col=='database'">
                                    <a-select v-model="record.databaseId">
                                        <a-select-option :value="1">paper</a-select-option>
                                    </a-select>
                                </a-form-model-item>
                            </template>
                            <template slot="operation" slot-scope="text,record,index">
                                <a-icon type="minus" @click="handleDeleteVariables(index)"/>
                                <a-icon type="plus" @click="handleAddVariables(index)"/>
                            </template>
                            <a-icon type="plus" slot="footer" v-if="testcaseGroupForm.variables.length<=0" @click="handleAddVariables(0)"/>
                        </a-table>
                    </a-collapse-panel>
                    <a-collapse-panel key="parameters" header="Parameters">
                        <a-table :columns="parametersColumns" :pagination="false" :data-source="testcaseGroupForm.parameters">
                            <template v-for="col in ['name', 'value']"
                                      :slot="col"
                                      slot-scope="text,record,index"
                            >
                                <a-form-model-item v-if="col == 'name'">
                                    <a-input v-model="record.name"/>
                                </a-form-model-item>
                                <a-form-model-item v-if="col == 'value'">
                                    <a-input v-model="record.value"/>
                                </a-form-model-item>
                            </template>
                            <template slot="operation" slot-scope="text,record,index">
                                <a-icon type="minus" @click="handleDeleteParameters(index)"/>
                                <a-icon type="plus" @click="handleAddParameters(index)"/>
                            </template>
                            <a-icon type="plus" slot="footer" v-if="testcaseGroupForm.parameters.length<=0" @click="handleAddParameters(0)"/>
                        </a-table>
                    </a-collapse-panel>
                    <a-collapse-panel key="setupHooks" header="SetupHooks">
                        <a-table :columns="setuphooksColumns" :pagination="false" :data-source="testcaseGroupForm.setupHooks">
                            <template v-for="col in ['sql','database']"
                                      :slot="col"
                                      slot-scope="text,record,index">
                                <a-form-model-item v-if="col == 'sql'">
                                    <a-input v-model="record.sql"/>
                                </a-form-model-item>
                                <a-form-model-item v-if="col == 'database'">
                                    <a-select v-model="record.databaseId">
                                        <a-select-option :value="1">paper</a-select-option>
                                    </a-select>
                                </a-form-model-item>
                            </template>
                            <template slot="operation" slot-scope="text,record,index">
                                <a-icon type="minus" @click="handleDeleteSetupHooks(index)"/>
                                <a-icon type="plus" @click="handleAddSetupHooks(index)"/>
                            </template>
                            <a-icon type="plus" slot="footer" v-if="testcaseGroupForm.setupHooks.length<=0" @click="handleAddSetupHooks(0)"/>
                        </a-table>
                    </a-collapse-panel>
                </a-collapse>
        </a-form-model>
            <div>
                <a-select v-model="chooseProjectId" placeholder="选择环境" class="select-project">
                    <a-select-option :value="item.id" v-for="item in projects">
                        {{ item.projectName }}
                    </a-select-option>
                </a-select>
                <div class="choose-config">
                    <a-button type="primary" icon="plus" ghost @click="handleChooseConfig" class="btn">
                        选择配置项
                    </a-button>
                    <a-table :columns="editConfigs" :data-source="chooseConfig" rowKey="id">
                        <span slot="operation" slot-scope="text,record,index">
                            <a-icon type="minus" @click="handleDeleteConfig(index)"/>
                        </span>
                    </a-table>
                </div>
                <div class="choose-case">
                    <a-button type="primary" icon="plus" ghost @click="handleChooseCase" class="btn">
                        选择用例
                    </a-button>
                    <a-table :columns="editCases" :data-source="chooseCase" rowKey="caseId">
                        <span slot="operation" slot-scope="text,record,index">
                            <a-icon type="minus" @click="handleDeleteCase(index)"/>
                        </span>
                    </a-table>
                </div>
            </div>

            </div>
        <div>
            <router-view v-if="$route.meta.levels === 3"></router-view>
        </div>
    </div>
</template>

<script lang="ts">
    import { Component, Vue, Prop } from 'vue-property-decorator';
    import { projectList } from '@/services/project/index';

    interface TestcaseGroup {
        projectName: string,
        projectId: number|null,
        envId: number,
        variables: any[],
        parameters: any[],
        setupHooks: any[]
    }

    interface Project {
        id: number,
        projectName: string
    }

    interface ChooseConfig {
        id: number,
        configName: string
    }

    interface ChooseCase {
        id: number;
        interfaceName: string;
        caseId: number;
        caseName: string;
    }

    @Component({
        components: {}
    })

    export default class AddGroup extends Vue {
        private testcaseGroupForm={
            groupName: '',
            projectId: null,
            envId: 1,
            variables: [],
            parameters: [],
            setupHooks: []
        }

        private projects: Project[]=[];

        private chooseProjectId=null;

        //是个变量
        get chooseConfig(): ChooseConfig[] {
            return this.$store.getters.caseGroupEditConfig;
        }

        get chooseCase(): ChooseCase[] {
            return this.$store.getters.caseGroupEditCase;
        }

        private mounted(): void {
            this.projectList();
        }

        private projectList(){
            projectList().then(
                (result: any)=>{
                    this.projects=result.retval;
                },
                (err: any)=>{
                    this.$message;
                }
            )
        }

        private handleAddVariables(index: number):void {
            const newData = {
                key: (new Date()).valueOf(),
                name: '',
                type: 'String',
                value: '',
                databaseId: ''
            };
            this.testcaseGroupForm.variables.splice(index+1,0,newData);
        }

        private handleDeleteVariables(index: number): void {
            this.testcaseGroupForm.variables.splice(index,1);
        }

        private handleAddParameters(index: number): void {
            const newData = {
                key: (new Date()).valueOf(),
                name: '',
                value: ''
            };
            this.testcaseGroupForm.parameters.splice(index+1,0,newData);
        }

        private handleDeleteParameters(index: number): void {
            this.testcaseGroupForm.parameters.splice(index,1);
        }

        private handleAddSetupHooks(index: number): void {
            const newData = {
                key: (new Date()).valueOf(),
                sql: '',
                databaseId: ''
            };
            this.testcaseGroupForm.setupHooks.splice(index+1,0,newData);
        }

        private handleDeleteSetupHooks(index: number): void {
            this.testcaseGroupForm.setupHooks.splice(index,1);
        }

        private handleChooseCase(): void {
            this.$router.push({
                name: 'chooseCase',
                params: {id: String(this.chooseProjectId)}
            });
        }

        private handleChooseConfig(): void {
            this.$router.push({
                name: 'chooseConfig'
            });
        }

        private handleDeleteConfig(index: number): void {
            this.chooseConfig.splice(index,1);
            this.$store.commit('caseGroupEditConfig',this.chooseConfig);
        }

        private handleDeleteCase(index: number): void {
            this.chooseCase.splice(index,1);
            this.$store.commit('caseGroupEditCase',this.chooseCase);
        }

        private variablesColumns= [
            {
                title: 'name',
                dataIndex: 'name',
                width: '15%',
                scopedSlots: { customRender: 'name' },
            },
            {
                title: 'type',
                dataIndex: 'type',
                width: '10%',
                scopedSlots: { customRender: 'type' },
            },
            {
                title: 'value',
                dataIndex: 'value',
                scopedSlots: { customRender: 'value' },
            },
            {
                title: '所属数据库',
                dataIndex: 'database',
                scopedSlots: { customRender: 'database' },
            },
            {
                title: '操作',
                dataIndex: 'operation',
                scopedSlots: { customRender: 'operation' },
            },
        ];
        private parametersColumns= [
            {
                title: 'name',
                dataIndex: 'keyName',
                width: '15%',
                scopedSlots: {customRender: 'name'},
            },
            {
                title: 'value',
                dataIndex: 'value',
                scopedSlots: { customRender: 'value' },
            },
            {
                title: '操作',
                dataIndex: 'operation',
                scopedSlots: { customRender: 'operation' },
            },
        ]
        private setuphooksColumns = [
            {
                title: 'sql',
                dataIndex: 'sql',
                width: '50%',
                scopedSlots: {customRender: 'sql'},
            },
            {
                title: '所属数据库',
                dataIndex: 'database',
                scopedSlots: { customRender: 'database' },
            },
            {
                title: '操作',
                dataIndex: 'operation',
                scopedSlots: { customRender: 'operation' },
            },
        ]

        private editConfigs = [
            {
                title: 'id',
                dataIndex: 'id',
            },
            {
                title: 'configName',
                dataIndex: 'configName'
            },
            {
                title: '操作',
                dataIndex: 'operation',
                scopedSlots: { customRender: 'operation'}
            }
        ]

        private editCases = [
            {
                title: 'id',
                dataIndex: 'id',
            },
            {
                title: 'interfaceName',
                dataIndex: 'interfaceName'
            },
            {
                title: 'caseId',
                dataIndex: 'caseId',
            },
            {
                title: 'caseName',
                dataIndex: 'caseName'
            },
            {
                title: '操作',
                dataIndex: 'operation',
                scopedSlots: { customRender: 'operation'}
            }
        ]
    }
</script>

<style>
    .select-project {
        margin-top: 10px;
        width: 200px;
    }

    .choose-config {
        margin-top: 20px;
        margin-bottom: 20px;
    }

    .btn {
        margin-bottom: 5px;
    }

</style>
